REPORT ZMM_CLOSE_OPEN_PO.

TABLES: ekko, ekpo, zpo_close_log.

TYPES: BEGIN OF ty_po_close,
         ebeln TYPE ekko-ebeln,
         ebelp TYPE ekpo-ebelp,
         lifnr TYPE ekko-lifnr,
         matnr TYPE ekpo-matnr,
         open_qty TYPE ekpo-qty,
         closure_flag TYPE c LENGTH 1,
         status_msg TYPE string,
       END OF ty_po_close.

DATA: lt_po_close TYPE TABLE OF ty_po_close,
      ls_po_close TYPE ty_po_close,
      lv_simulate TYPE abap_bool.

SELECTION-SCREEN BEGIN OF BLOCK b1 WITH FRAME TITLE text-001.
SELECT-OPTIONS: s_ekorg FOR ekko-ekorg,
                s_werks FOR ekpo-werks,
                s_lifnr FOR ekko-lifnr,
                s_ebeln FOR ekko-ebeln,
                s_date_range FOR ekpo-budat.
PARAMETERS: p_simulate AS CHECKBOX.
SELECTION-SCREEN END OF BLOCK b1.

START-OF-SELECTION.
  " Fetch open purchase orders
  PERFORM fetch_open_pos.
  " Display ALV grid
  PERFORM display_alv.

FORM fetch_open_pos.
  " Select open purchase orders from EKKO and EKPO
  SELECT ebeln, ebelp, lifnr, matnr, qty
    INTO TABLE lt_po_close
    FROM ekko AS a
    INNER JOIN ekpo AS b ON a.ebeln = b.ebeln
    WHERE a.ekorg IN s_ekorg
      AND b.werks IN s_werks
      AND a.lifnr IN s_lifnr
      AND a.ebeln IN s_ebeln
      AND b.budat IN s_date_range
      AND b.qty > 0.

  " Initialize closure flag and status message
  LOOP AT lt_po_close INTO ls_po_close.
    ls_po_close-closure_flag = ' '.
    ls_po_close-status_msg = ''.
    MODIFY lt_po_close FROM ls_po_close.
  ENDLOOP.
ENDFORM.

FORM display_alv.
  DATA: lo_alv TYPE REF TO cl_gui_alv_grid,
        lt_fieldcat TYPE lvc_t_fcat,
        ls_fieldcat TYPE lvc_s_fcat.

  " Define field catalog for ALV
  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname = 'EBELN'.
  ls_fieldcat-seltext_m = 'PO Number'.
  APPEND ls_fieldcat TO lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname = 'EBELP'.
  ls_fieldcat-seltext_m = 'Item'.
  APPEND ls_fieldcat TO lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname = 'LIFNR'.
  ls_fieldcat-seltext_m = 'Vendor'.
  APPEND ls_fieldcat TO lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname = 'MATNR'.
  ls_fieldcat-seltext_m = 'Material'.
  APPEND ls_fieldcat TO lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname = 'OPEN_QTY'.
  ls_fieldcat-seltext_m = 'Open Qty'.
  APPEND ls_fieldcat TO lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname = 'CLOSURE_FLAG'.
  ls_fieldcat-seltext_m = 'Closure Flag'.
  APPEND ls_fieldcat TO lt_fieldcat.

  CLEAR ls_fieldcat.
  ls_fieldcat-fieldname = 'STATUS_MSG'.
  ls_fieldcat-seltext_m = 'Status Message'.
  APPEND ls_fieldcat TO lt_fieldcat.

  " Create ALV Grid
  CREATE OBJECT lo_alv
    EXPORTING
      i_parent = cl_gui_container=>screen0.

  " Set ALV data
  CALL METHOD lo_alv->set_table_for_first_display
    EXPORTING
      i_structure_name = 'ZSTR_PO_CLOSE'
      it_fieldcatalog = lt_fieldcat
    CHANGING
      it_outtab = lt_po_close.

  " User selection for closure
  CALL METHOD lo_alv->register_edit_event
    EXPORTING
      i_event_id = cl_gui_alv_grid=>mc_evt_modified.

  " Display ALV
  CALL METHOD lo_alv->refresh_table_display.
ENDFORM.

FORM close_selected_pos.
  " Loop through selected purchase orders to close
  LOOP AT lt_po_close INTO ls_po_close WHERE closure_flag = 'X'.
    CALL FUNCTION 'BAPI_PO_CHANGE'
      EXPORTING
        purchaseorder = ls_po_close-ebeln
        item = ls_po_close-ebelp
        delivery_complete = 'X'
      IMPORTING
        return = DATA(lv_return).

    " Check return message and log status
    IF lv_return-type = 'S'.
      ls_po_close-status_msg = 'Closed Successfully'.
      INSERT VALUE #( ebeln = ls_po_close-ebeln
                       ebelp = ls_po_close-ebelp
                       lifnr = ls_po_close-lifnr
                       matnr = ls_po_close-matnr
                       status_msg = ls_po_close-status_msg ) INTO zpo_close_log.
    ELSE.
      ls_po_close-status_msg = lv_return-message.
    ENDIF.

    MODIFY lt_po_close FROM ls_po_close.
  ENDLOOP.

  " Commit transaction
  CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'.
ENDFORM.

AT USER-COMMAND.
  IF sy-ucomm = 'CLOSE'.
    " Close selected purchase orders
    PERFORM close_selected_pos.
    " Refresh ALV display
    PERFORM display_alv.
  ENDIF.